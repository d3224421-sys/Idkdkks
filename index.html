<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Global Chat â€” Hack7rBGG / Xymatekidd</title>
<style>
  :root{ --bg1:#071020; --bg2:#12202b; --card:rgba(255,255,255,0.03); }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:#fff}
  .wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:18px;box-sizing:border-box}
  .app{width:100%;max-width:720px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.12));border-radius:12px;padding:12px;box-shadow:0 10px 40px rgba(0,0,0,0.6);display:flex;flex-direction:column;gap:12px}
  .header{display:flex;justify-content:space-between;align-items:center}
  .title{display:flex;gap:12px;align-items:center}
  .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,#00e0ff,#7b61ff);display:flex;align-items:center;justify-content:center;font-weight:700;color:#072}
  h1{font-size:18px;margin:0}
  p.sub{margin:0;color:#9aa3b2;font-size:13px}
  /* rainbow credit */
  .credit{font-weight:700;font-size:13px;padding:6px 10px;border-radius:999px;background:linear-gradient(90deg,#ff2d55,#ff7a18,#ffd600,#00e676,#00b0ff,#8e44ff);-webkit-background-clip:text;background-clip:text;color:transparent;animation:rainbowShift 4s linear infinite}
  @keyframes rainbowShift{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
  #chat-box{height:62vh;min-height:360px;max-height:78vh;overflow:auto;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(0,0,0,0.12))}
  .msg{margin:10px 0;max-width:86%;padding:10px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.15));border:1px solid rgba(255,255,255,0.03);animation:msgIn .28s ease}
  .msg.you{margin-left:auto;background:linear-gradient(180deg, rgba(0,188,212,0.12), rgba(0,188,212,0.06));border:1px solid rgba(0,188,212,0.12)}
  .meta{display:flex;justify-content:space-between;gap:8px;margin-bottom:6px;align-items:center}
  .name{font-weight:700;color:#bfefff;font-size:13px;cursor:pointer}
  .time{font-size:11px;color:#9aa3b2}
  .text{font-size:15px;color:#f3f7fb;line-height:1.35;word-break:break-word}
  @keyframes msgIn{from{transform:translateY(6px) scale(.995);opacity:0}to{transform:translateY(0) scale(1);opacity:1}}
  .footer{display:flex;gap:10px;align-items:center}
  .input{flex:1;display:flex;gap:8px;align-items:center}
  .input input[type="text"]{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:rgba(0,0,0,0.25);color:#fff;font-size:15px;outline:none}
  .send{padding:12px 14px;border-radius:10px;border:none;background:linear-gradient(90deg,#00e0ff,#7b61ff);color:#071028;font-weight:700;cursor:pointer}
  .controls{display:flex;gap:8px;align-items:center}
  .small-btn{padding:8px 10px;border-radius:8px;border:none;background:#222;color:#fff;cursor:pointer}
  .profile-modal, .view-modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:999;visibility:hidden;opacity:0;transition:opacity .14s}
  .modal-open{visibility:visible;opacity:1}
  .modal-card{width:92%;max-width:420px;background:#0f1720;border-radius:12px;padding:14px;box-shadow:0 10px 40px rgba(0,0,0,0.6)}
  .avatar{width:68px;height:68px;border-radius:10px;object-fit:cover;border:2px solid rgba(255,255,255,0.06)}
  .profile-row{display:flex;gap:12px;align-items:center}
  .field{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(0,0,0,0.2);color:#fff}
  .img-thumb{max-width:180px;border-radius:8px;display:block;margin-top:8px}
  .credit-bottom{display:flex;justify-content:space-between;align-items:center;font-size:13px;color:#9aa3b2;padding-top:6px}
  @media(max-width:420px){#chat-box{height:64vh;min-height:320px}h1{font-size:16px}}
</style>
</head>
<body>
  <div class="wrap">
    <div class="app" role="application">
      <div class="header">
        <div class="title">
          <div class="logo">GC</div>
          <div>
            <h1>Global Chat</h1>
            <p class="sub">Realtime chat â€” click a name to view profile</p>
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:10px">
          <button id="editProfileBtn" class="small-btn" title="Edit profile">Edit profile</button>
          <div class="credit">Hack7rBGG / Xymatekidd</div>
        </div>
      </div>

      <div id="chat-box" aria-live="polite"></div>

      <div class="footer">
        <div class="input">
          <input id="messageInput" type="text" placeholder="Type a message..." />
        </div>

        <div class="controls">
          <input id="fileInput" type="file" accept="image/*" style="display:none">
          <button id="imgBtn" class="small-btn" title="Send image">ðŸ“·</button>
          <button id="sendBtn" class="send">Send</button>
        </div>
      </div>

      <div class="credit-bottom">
        <div>Built by <strong style="background:linear-gradient(90deg,#ff2d55,#ff7a18,#ffd600,#00e676,#00b0ff,#8e44ff);-webkit-background-clip:text;color:transparent">Hack7rBGG / Xymatekidd</strong></div>
        <div style="font-size:12px;color:#8d9bb0">Mobile-ready</div>
      </div>
    </div>
  </div>

  <!-- PROFILE EDIT MODAL -->
  <div id="profileModal" class="profile-modal" role="dialog" aria-hidden="true">
    <div class="modal-card">
      <h3>Edit Profile</h3>
      <div class="profile-row">
        <img id="profileAvatar" class="avatar" src="" alt="avatar">
        <div style="flex:1">
          <input id="nameField" class="field" placeholder="Display name (required)">
          <textarea id="bioField" class="field" placeholder="Short bio (optional)" style="height:90px;margin-top:8px"></textarea>
          <input id="avatarInput" type="file" accept="image/*" style="margin-top:8px">
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="saveProfileBtn" class="small-btn">Save</button>
            <button id="closeProfileBtn" class="small-btn">Close</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- VIEW PROFILE MODAL -->
  <div id="viewModal" class="view-modal" role="dialog" aria-hidden="true">
    <div class="modal-card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 id="viewName">Profile</h3>
        <button id="closeViewBtn" class="small-btn">Close</button>
      </div>
      <div style="display:flex;gap:12px;align-items:flex-start;margin-top:8px">
        <img id="viewAvatar" class="avatar" src="">
        <div style="flex:1">
          <div id="viewBio" style="color:#cfe6ff"></div>
          <div id="viewId" style="color:#9aa3b2;margin-top:8px;font-size:12px"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase modular SDK -->
  <script type="module">
    // imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, set, get, child, query, limitToLast } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    import { getStorage, ref as sref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    // ---------- REPLACE WITH YOUR CONFIG IF DIFFERENT ----------
    const firebaseConfig = {
      apiKey: "AIzaSyBhBysX0vCpjgBybXAto1eVGJg4BMNPcE",
      authDomain: "global-chat-4ebaf.firebaseapp.com",
      databaseURL: "https://global-chat-4ebaf-default-rtdb.firebaseio.com",
      projectId: "global-chat-4ebaf",
      storageBucket: "global-chat-4ebaf.appspot.com",
      messagingSenderId: "932946585758",
      appId: "1:932946585758:web:299df72156b9222774b93"
    };
    // ----------------------------------------------------------

    // init
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const storage = getStorage(app);

    // UI refs
    const chatBox = document.getElementById('chat-box');
    const msgInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const imgBtn = document.getElementById('imgBtn');
    const fileInput = document.getElementById('fileInput');
    const editProfileBtn = document.getElementById('editProfileBtn');
    const profileModal = document.getElementById('profileModal');
    const profileAvatar = document.getElementById('profileAvatar');
    const avatarInput = document.getElementById('avatarInput');
    const nameField = document.getElementById('nameField');
    const bioField = document.getElementById('bioField');
    const saveProfileBtn = document.getElementById('saveProfileBtn');
    const closeProfileBtn = document.getElementById('closeProfileBtn');

    const viewModal = document.getElementById('viewModal');
    const viewName = document.getElementById('viewName');
    const viewAvatar = document.getElementById('viewAvatar');
    const viewBio = document.getElementById('viewBio');
    const viewId = document.getElementById('viewId');
    const closeViewBtn = document.getElementById('closeViewBtn');

    // user identity (persisted)
    let uid = localStorage.getItem('gc_uid');
    if (!uid) {
      uid = 'u' + Date.now().toString(36) + Math.floor(Math.random()*9000);
      localStorage.setItem('gc_uid', uid);
    }

    let username = localStorage.getItem('gc_name');
    if (!username) {
      username = 'User' + Math.floor(Math.random()*9000);
      localStorage.setItem('gc_name', username);
    }

    let userAvatar = localStorage.getItem('gc_avatar') || '';
    let userBio = localStorage.getItem('gc_bio') || '';

    // fill profile modal fields
    function refreshProfileUI(){
      nameField.value = username || '';
      bioField.value = userBio || '';
      profileAvatar.src = userAvatar || 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="140" height="140"><rect width="100%" height="100%" fill="%23222"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="%23fff">Avatar</text></svg>';
    }
    refreshProfileUI();

    // send text message
    function sendMessage(imageUrl = null){
      const text = msgInput.value.trim();
      if (!text && !imageUrl) return;
      const mref = ref(db, 'messages');
      const payload = {
        uid,
        name: username,
        text: text || '',
        time: Date.now(),
        image: imageUrl || null
      };
      push(mref, payload).catch(e => console.error(e));
      msgInput.value = '';
    }

    sendBtn.addEventListener('click', ()=> sendMessage());
    msgInput.addEventListener('keydown', (e)=> { if (e.key === 'Enter') sendMessage(); });

    // image send flow
    imgBtn.addEventListener('click', ()=> fileInput.click());
    fileInput.addEventListener('change', async (ev)=>{
      const file = ev.target.files && ev.target.files[0];
      if (!file) return;
      // upload to storage
      const path = `images/${uid}/${Date.now()}_${file.name.replace(/\s+/g,'_')}`;
      const sR = sref(storage, path);
      const uploadTask = uploadBytesResumable(sR, file);
      // simple progress UI (replace with fancier if wanted)
      uploadTask.on('state_changed', 
        (snapshot)=>{/*progress optional*/}, 
        (err)=>{alert('Upload failed: '+err.message);}, 
        async ()=> {
          const url = await getDownloadURL(uploadTask.snapshot.ref);
          // send message with image url
          sendMessage(url);
          fileInput.value = '';
        }
      );
    });

    // listen for new messages (last 300)
    const q = query(ref(db,'messages'), limitToLast(300));
    onChildAdded(q, snap => {
      const data = snap.val();
      if (!data) return;
      renderMessage(data);
    });

    // render message
    function renderMessage(m){
      const d = document.createElement('div');
      d.className = 'msg' + (m.uid === uid ? ' you' : '');
      const time = (new Date(m.time)).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
      // username clickable to view profile
      const nameHtml = `<span class="name" data-uid="${escapeHtml(m.uid)}">${escapeHtml(m.name || 'User')}</span>`;
      const imageHtml = m.image ? `<div style="margin-top:8px"><img src="${escapeHtml(m.image)}" style="max-width:220px;border-radius:8px"></div>` : '';
      d.innerHTML = `<div class="meta"><div>${nameHtml}</div><div class="time">${time}</div></div>
                     <div class="text">${escapeHtml(m.text)}</div>
                     ${imageHtml}`;
      chatBox.appendChild(d);
      // attach click handler for name
      d.querySelectorAll('.name').forEach(el=> el.addEventListener('click',(e)=> openProfile(el.dataset.uid)));
      // keep chat short for performance
      while (chatBox.children.length > 600) chatBox.removeChild(chatBox.firstChild);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // open profile viewer â€” loads from DB if exists, otherwise shows stored local
    async function openProfile(viewUid){
      if (!viewUid) return;
      const pRef = ref(db, `profiles/${viewUid}`);
      try {
        const snap = await get(pRef);
        let pdata = snap.exists() ? snap.val() : null;
        // if it's this user show local copy fallback
        if (!pdata && viewUid === uid) {
          pdata = { name: username, bio: userBio, avatar: userAvatar };
        }
        viewName.textContent = pdata?.name || 'Unknown';
        viewBio.textContent = pdata?.bio || '';
        viewAvatar.src = pdata?.avatar || profileAvatar.src;
        viewId.textContent = `id: ${viewUid}`;
        viewModal.classList.add('modal-open');
      } catch(e){
        console.error(e);
        alert('Failed to open profile');
      }
    }

    // profile modal open
    editProfileBtn.addEventListener('click', ()=> {
      profileModal.classList.add('modal-open'); profileModal.setAttribute('aria-hidden','false'); refreshProfileUI();
    });
    closeProfileBtn.addEventListener('click', ()=> { profileModal.classList.remove('modal-open'); profileModal.setAttribute('aria-hidden','true'); });
    closeViewBtn.addEventListener('click', ()=> viewModal.classList.remove('modal-open'));

    // avatar file upload for profile
    avatarInput.addEventListener('change', async (ev)=>{
      const f = ev.target.files && ev.target.files[0];
      if (!f) return;
      const path = `avatars/${uid}/${Date.now()}_${f.name.replace(/\s+/g,'_')}`;
      const sR = sref(storage, path);
      const uploadTask = uploadBytesResumable(sR, f);
      uploadTask.on('state_changed', ()=>{}, (err)=> alert('Avatar upload failed: '+err.message), async ()=>{
        const url = await getDownloadURL(uploadTask.snapshot.ref);
        userAvatar = url; localStorage.setItem('gc_avatar', userAvatar);
        profileAvatar.src = userAvatar;
      });
    });

    // save profile to Realtime DB + localStorage
    saveProfileBtn.addEventListener('click', async ()=>{
      const n = (nameField.value || '').trim();
      const b = (bioField.value || '').trim();
      if (!n) return alert('Please enter a display name');
      username = n; userBio = b;
      localStorage.setItem('gc_name', username);
      localStorage.setItem('gc_bio', userBio);
      // ensure avatar is saved from localStorage if any
      if (userAvatar) localStorage.setItem('gc_avatar', userAvatar);
      // write to DB under profiles/<uid>
      try {
        await set(ref(db, `profiles/${uid}`), {
          name: username,
          bio: userBio || '',
          avatar: userAvatar || ''
        });
        profileModal.classList.remove('modal-open');
        alert('Profile saved');
      } catch(e){
        console.error(e); alert('Failed to save profile: '+e.message);
      }
    });

    // small helper
    function escapeHtml(s=''){ return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }

    // focus input
    msgInput.focus();

  </script>

  <!-- Instructions: Firebase rules for testing (copy/paste into console) -->
  <!--
    IMPORTANT: For initial testing, set these rules. They allow public read/write.
    Later tighten rules or add Authentication.

    Realtime Database (Rules):
    {
      "rules": {
        ".read": true,
        ".write": true
      }
    }

    Storage (Rules):
    // Go to Storage -> Rules and set to:
    rules_version = '2';
    service firebase.storage {
      match /b/{bucket}/o {
        match /{allPaths=**} {
          allow read, write: if true;
        }
      }
    }

    WARNING: These test rules are open to the public (anyone can upload/delete). 
    Use only while testing. When you want production, configure authentication and stricter rules.
  -->

</body>
  </html>
