<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Global Chat â€” Hack7rBGG / Xymatekidd</title>
<style>
  :root{--bg1:#071020;--bg2:#12202b;--card:rgba(255,255,255,0.03)}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:#fff}
  .wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:18px;box-sizing:border-box}
  .app{width:100%;max-width:820px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.12));border-radius:12px;padding:14px;box-shadow:0 10px 40px rgba(0,0,0,0.6);display:flex;flex-direction:column;gap:12px}
  .header{display:flex;justify-content:space-between;align-items:center}
  .title{display:flex;gap:12px;align-items:center}
  .logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,#00e0ff,#7b61ff);display:flex;align-items:center;justify-content:center;font-weight:700;color:#072}
  h1{font-size:18px;margin:0}
  p.sub{margin:0;color:#9aa3b2;font-size:13px}
  .credit{font-weight:700;font-size:13px;padding:6px 10px;border-radius:999px;background:linear-gradient(90deg,#ff2d55,#ff7a18,#ffd600,#00e676,#00b0ff,#8e44ff);-webkit-background-clip:text;background-clip:text;color:transparent;animation:rainbowShift 4s linear infinite}
  @keyframes rainbowShift{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
  #chat-box{height:62vh;min-height:360px;max-height:78vh;overflow:auto;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(0,0,0,0.12))}
  .msg{margin:10px 0;max-width:86%;padding:10px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.15));border:1px solid rgba(255,255,255,0.03);animation:msgIn .28s ease}
  .msg.you{margin-left:auto;background:linear-gradient(180deg, rgba(0,188,212,0.12), rgba(0,188,212,0.06));border:1px solid rgba(0,188,212,0.12)}
  .meta{display:flex;justify-content:space-between;gap:8px;margin-bottom:6px;align-items:center}
  .name{font-weight:700;color:#bfefff;font-size:13px;cursor:pointer}
  .time{font-size:11px;color:#9aa3b2}
  .text{font-size:15px;color:#f3f7fb;line-height:1.35;word-break:break-word}
  .msg img{max-width:220px;border-radius:8px;margin-top:8px;display:block}
  @keyframes msgIn{from{transform:translateY(6px) scale(.995);opacity:0}to{transform:translateY(0) scale(1);opacity:1}}
  .footer{display:flex;gap:10px;align-items:center}
  .input{flex:1;display:flex;gap:8px;align-items:center}
  .input input[type="text"]{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:rgba(0,0,0,0.25);color:#fff;font-size:15px;outline:none}
  .send{padding:12px 14px;border-radius:10px;border:none;background:linear-gradient(90deg,#00e0ff,#7b61ff);color:#071028;font-weight:700;cursor:pointer}
  .controls{display:flex;gap:8px;align-items:center}
  .small-btn{padding:8px 10px;border-radius:8px;border:none;background:#222;color:#fff;cursor:pointer}
  .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:999;visibility:hidden;opacity:0;transition:opacity .14s}
  .modal-open{visibility:visible;opacity:1}
  .card{width:92%;max-width:480px;background:#0f1720;border-radius:12px;padding:14px;box-shadow:0 10px 40px rgba(0,0,0,0.6)}
  .avatar{width:78px;height:78px;border-radius:10px;object-fit:cover;border:2px solid rgba(255,255,255,0.06)}
  .row{display:flex;gap:12px;align-items:center}
  .field{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(0,0,0,0.2);color:#fff}
  .img-thumb{max-width:220px;border-radius:8px;display:block;margin-top:8px}
  .bottom{display:flex;justify-content:space-between;align-items:center;font-size:13px;color:#9aa3b2;padding-top:6px}
  @media(max-width:420px){#chat-box{height:64vh;min-height:320px}h1{font-size:16px}}
</style>
</head>
<body>
  <div class="wrap">
    <div class="app" role="application">
      <div class="header">
        <div class="title">
          <div class="logo">GC</div>
          <div>
            <h1>Global Chat</h1>
            <p class="sub">Realtime chat â€” tap a name to view profile</p>
          </div>
        </div>

        <div style="display:flex;align-items:center;gap:10px">
          <button id="profileBtn" class="small-btn" title="Edit profile">Profile</button>
          <div class="credit">Hack7rBGG / Xymatekidd</div>
        </div>
      </div>

      <div id="chat-box" aria-live="polite"></div>

      <div class="footer">
        <div class="input">
          <input id="messageInput" type="text" placeholder="Type a message..." />
        </div>

        <div class="controls">
          <input id="fileInput" type="file" accept="image/*" style="display:none">
          <button id="imgBtn" class="small-btn" title="Send image">ðŸ“·</button>
          <button id="sendBtn" class="send">Send</button>
        </div>
      </div>

      <div class="bottom">
        <div>Built by <strong style="background:linear-gradient(90deg,#ff2d55,#ff7a18,#ffd600,#00e676,#00b0ff,#8e44ff);-webkit-background-clip:text;color:transparent">Hack7rBGG / Xymatekidd</strong></div>
        <div style="font-size:12px;color:#8d9bb0">Mobile-ready</div>
      </div>
    </div>
  </div>

  <!-- Profile Edit Modal -->
  <div id="profileModal" class="modal" aria-hidden="true">
    <div class="card">
      <h3>Edit Profile</h3>
      <div class="row" style="margin-top:8px">
        <img id="localAvatar" class="avatar" src="" alt="avatar">
        <div style="flex:1">
          <input id="nameField" class="field" placeholder="Display name (required)">
          <textarea id="bioField" class="field" placeholder="Short bio (optional)" style="height:84px;margin-top:8px"></textarea>
          <input id="avatarInput" type="file" accept="image/*" style="margin-top:8px">
          <div style="display:flex;gap:8px;margin-top:10px">
            <button id="saveProfile" class="small-btn">Save</button>
            <button id="closeProfile" class="small-btn">Close</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- View Profile Modal -->
  <div id="viewModal" class="modal" aria-hidden="true">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 id="viewName">Profile</h3>
        <button id="closeView" class="small-btn">Close</button>
      </div>
      <div style="display:flex;gap:12px;align-items:flex-start;margin-top:8px">
        <img id="viewAvatar" class="avatar" src="">
        <div style="flex:1">
          <div id="viewBio" style="color:#cfe6ff"></div>
          <div id="viewId" style="color:#9aa3b2;margin-top:8px;font-size:12px"></div>
        </div>
      </div>
    </div>
  </div>

<script type="module">
/* -------------------------
   CONFIG: ImgBB + Firebase
   ------------------------- */
const IMGBB_KEY = '07a9d6443a5763e108eb7f047bd4421a'; // your key
const firebaseConfig = {
  apiKey: "AIzaSyBhBysX0vCpjgBybXAto1eVGJg4BMNPcE",
  authDomain: "global-chat-4ebaf.firebaseapp.com",
  databaseURL: "https://global-chat-4ebaf-default-rtdb.firebaseio.com",
  projectId: "global-chat-4ebaf",
  storageBucket: "global-chat-4ebaf.appspot.com",
  messagingSenderId: "932946585758",
  appId: "1:932946585758:web:299df72156b9222774b93"
};

/* -------------------------
   Firebase imports + init
   ------------------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, push, onChildAdded, set, get, child, query, limitToLast } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* -------------------------
   UI refs
   ------------------------- */
const chatBox = document.getElementById('chat-box');
const msgInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const imgBtn = document.getElementById('imgBtn');
const fileInput = document.getElementById('fileInput');
const profileBtn = document.getElementById('profileBtn');

const profileModal = document.getElementById('profileModal');
const localAvatar = document.getElementById('localAvatar');
const avatarInput = document.getElementById('avatarInput');
const nameField = document.getElementById('nameField');
const bioField = document.getElementById('bioField');
const saveProfile = document.getElementById('saveProfile');
const closeProfile = document.getElementById('closeProfile');

const viewModal = document.getElementById('viewModal');
const viewName = document.getElementById('viewName');
const viewAvatar = document.getElementById('viewAvatar');
const viewBio = document.getElementById('viewBio');
const viewId = document.getElementById('viewId');
const closeView = document.getElementById('closeView');

/* -------------------------
   Local identity (persist)
   ------------------------- */
let uid = localStorage.getItem('gc_uid');
if (!uid) {
  uid = 'u' + Date.now().toString(36) + Math.floor(Math.random()*9000);
  localStorage.setItem('gc_uid', uid);
}

let name = localStorage.getItem('gc_name');
if (!name) {
  name = 'User' + Math.floor(Math.random()*9000);
  localStorage.setItem('gc_name', name);
}
let bio = localStorage.getItem('gc_bio') || '';
let avatarURL = localStorage.getItem('gc_avatar') || '';

function refreshProfileUI(){
  nameField.value = name || '';
  bioField.value = bio || '';
  localAvatar.src = avatarURL || ('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="140" height="140"><rect width="100%" height="100%" fill="%23222"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="%23fff">Avatar</text></svg>');
}
refreshProfileUI();

/* -------------------------
   Utilities
   ------------------------- */
function escapeHtml(s=''){ return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }
function formatTime(ts){ try{ return new Date(ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});}catch(e){return '';} }

/* -------------------------
   Send text message
   ------------------------- */
async function sendMessage(imageUrl=null){
  const text = (msgInput.value||'').trim();
  if (!text && !imageUrl) return;
  const payload = {
    uid,
    name,
    bio: bio || '',
    avatar: avatarURL || '',
    text: text || '',
    image: imageUrl || null,
    time: Date.now()
  };
  try {
    await push(ref(db, 'messages'), payload);
    msgInput.value = '';
  } catch(e){ console.error('push failed', e); alert('Failed to send message'); }
}
sendBtn.addEventListener('click', ()=> sendMessage());
msgInput.addEventListener('keydown', (e)=> { if (e.key === 'Enter') sendMessage(); });

/* -------------------------
   Image upload via ImgBB
   - read file as base64 then POST to ImgBB
   - returns JSON.data.url
   ------------------------- */
async function uploadToImgBB(file){
  return new Promise((res, rej)=>{
    const reader = new FileReader();
    reader.onload = async () => {
      try {
        const base64 = reader.result.split(',')[1]; // remove data: prefix
        const form = new FormData();
        form.append('image', base64);
        // optional: name
        form.append('name', `${uid}_${Date.now()}`);
        const resp = await fetch(`https://api.imgbb.com/1/upload?key=${encodeURIComponent(IMGBB_KEY)}`, {
          method: 'POST',
          body: form
        });
        const data = await resp.json();
        if (data && data.success && data.data && data.data.url) return res(data.data.url);
        else return rej(new Error('ImgBB upload failed'));
      } catch(err){ rej(err); }
    };
    reader.onerror = ()=> rej(new Error('File read error'));
    reader.readAsDataURL(file);
  });
}

/* -------------------------
   Image send flow: choose file -> upload -> push message
   ------------------------- */
imgBtn.addEventListener('click', ()=> fileInput.click());
fileInput.addEventListener('change', async (ev)=>{
  const file = ev.target.files && ev.target.files[0];
  if (!file) return;
  try {
    // show small placeholder while uploading
    const placeholder = document.createElement('div');
    placeholder.className = 'msg you';
    placeholder.innerHTML = `<div class="meta"><div class="name">${escapeHtml(name)}</div><div class="time">...</div></div><div class="text">Uploading image...</div>`;
    chatBox.appendChild(placeholder);
    chatBox.scrollTop = chatBox.scrollHeight;

    const url = await uploadToImgBB(file);
    // remove placeholder
    placeholder.remove();
    await sendMessage(url);
  } catch(e){
    console.error(e);
    alert('Image upload failed: ' + (e.message||e));
  } finally {
    fileInput.value = '';
  }
});

/* -------------------------
   Listen for messages (last 300)
   ------------------------- */
const q = query(ref(db,'messages'), limitToLast(300));
onChildAdded(q, snap=>{
  const m = snap.val();
  if (!m) return;
  renderMessage(m);
});

/* -------------------------
   Render message
   ------------------------- */
function renderMessage(m){
  const el = document.createElement('div');
  el.className = 'msg' + (m.uid === uid ? ' you' : '');
  const time = formatTime(m.time);
  const nameHtml = `<span class="name" data-uid="${escapeHtml(m.uid)}">${escapeHtml(m.name || 'User')}</span>`;
  const imageHtml = m.image ? `<img src="${escapeHtml(m.image)}" alt="img">` : '';
  el.innerHTML = `<div class="meta"><div>${nameHtml}</div><div class="time">${time}</div></div>
                  <div class="text">${escapeHtml(m.text||'')}</div>
                  ${imageHtml}`;
  // attach click to view profile
  el.querySelectorAll('.name').forEach(n=>{
    n.addEventListener('click', ()=> openProfile(n.dataset.uid));
  });
  chatBox.appendChild(el);
  while (chatBox.children.length > 600) chatBox.removeChild(chatBox.firstChild);
  chatBox.scrollTop = chatBox.scrollHeight;
}

/* -------------------------
   Profile edit modal handlers
   ------------------------- */
profileBtn.addEventListener('click', ()=> { profileModal.classList.add('modal-open'); profileModal.setAttribute('aria-hidden','false'); refreshProfileUI(); });
closeProfile.addEventListener('click', ()=> { profileModal.classList.remove('modal-open'); profileModal.setAttribute('aria-hidden','true'); });

avatarInput.addEventListener('change', async (ev)=>{
  const f = ev.target.files && ev.target.files[0];
  if (!f) return;
  try {
    // upload avatar to ImgBB (same function)
    localAvatar.src = ''; // blank while uploading
    const url = await uploadToImgBB(f);
    avatarURL = url;
    localStorage.setItem('gc_avatar', avatarURL);
    localAvatar.src = avatarURL;
  } catch(e){ console.error(e); alert('Avatar upload failed'); }
});

saveProfile.addEventListener('click', async ()=>{
  const newName = (nameField.value || '').trim();
  const newBio = (bioField.value || '').trim();
  if (!newName) return alert('Please enter a display name');
  name = newName; bio = newBio;
  localStorage.setItem('gc_name', name);
  localStorage.setItem('gc_bio', bio);
  if (avatarURL) localStorage.setItem('gc_avatar', avatarURL);

  // save to database under /profiles/<uid>
  try {
    await set(ref(db, `profiles/${uid}`), { name, bio, avatar: avatarURL || '' });
    alert('Profile saved');
    profileModal.classList.remove('modal-open');
  } catch(e){ console.error(e); alert('Failed saving profile: '+(e.message||e)); }
});

/* -------------------------
   View profile
   ------------------------- */
async function openProfile(viewUid){
  if (!viewUid) return;
  try {
    const snap = await get(child(ref(db), `profiles/${viewUid}`));
    let pdata = snap.exists() ? snap.val() : null;
    if (!pdata && viewUid === uid) pdata = { name, bio, avatar: avatarURL };
    viewName.textContent = pdata?.name || 'Unknown';
    viewBio.textContent = pdata?.bio || '';
    viewAvatar.src = pdata?.avatar || localAvatar.src;
    viewId.textContent = `id: ${viewUid}`;
    viewModal.classList.add('modal-open');
  } catch(e){ console.error(e); alert('Failed to load profile'); }
}
closeView.addEventListener('click', ()=> viewModal.classList.remove('modal-open'));

/* -------------------------
   Focus input
   ------------------------- */
msgInput.focus();

</script>

<!--
  QUICK TEST RULES (Realtime DB) â€” paste into Firebase Console â†’ Realtime Database â†’ Rules
  --------------------------------------------------------------------------
  {
    "rules": {
      ".read": true,
      ".write": true
    }
  }
  --------------------------------------------------------------------------

  Notes:
  - ImgBB key is used to upload images; you created it so it's okay here.
  - Realtime DB public rules are only for testing. For production, enable Authentication and restrict writes (e.g. allow only authenticated users).
-->
</body>
  </html>
